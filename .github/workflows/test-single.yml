name: üé≠ Single Library Test

on:
  workflow_dispatch:
    inputs:
      library:
        description: 'Library to test'
        required: true
        type: choice
        options:
          - playwright
          - patchright
          - camoufox
          - rebrowser_playwright
      verbose:
        description: 'Enable verbose logging'
        required: false
        type: boolean
        default: false

jobs:
  test-single-library:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
      
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üü¢ Set up Node.js (for rebrowser)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        if: inputs.library == 'rebrowser_playwright'
      
      - name: üñ•Ô∏è Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libglib2.0-0 \
            libnss3 \
            libnspr4 \
            libdbus-1-3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2
      
      - name: üì¶ Install Core Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üì¶ Install Library-Specific Dependencies
        run: |
          echo "=========================================="
          echo "Installing: ${{ inputs.library }}"
          echo "=========================================="
          
          case "${{ inputs.library }}" in
            "playwright")
              echo "=== Installing Playwright ==="
              pip install playwright
              playwright install chromium
              playwright install-deps chromium
              python -c "from playwright.sync_api import sync_playwright; print('‚úÖ Playwright verified')"
              ;;
              
            "patchright")
              echo "=== Installing Patchright ==="
              pip install patchright
              patchright install chromium || echo "‚ö†Ô∏è Patchright install warning (non-fatal)"
              python -c "from patchright.sync_api import sync_playwright; print('‚úÖ Patchright verified')"
              ;;
              
            "camoufox")
              echo "=== Installing Camoufox ==="
              pip install 'camoufox[geoip]' pygeoip
              python -c "import camoufox; print('‚úÖ Camoufox verified')"
              echo "Note: Camoufox will download browser on first run"
              ;;
          
            "rebrowser_playwright")
              echo "=========================================="
              echo "=== Installing rebrowser-playwright ==="
              echo "=========================================="
              
              # Step 1: Install Python package
              echo "Step 1: Installing Python package..."
              pip install rebrowser-playwright || {
                echo "‚ùå FAILED: Could not install rebrowser-playwright Python package"
                exit 1
              }
              echo "‚úÖ Python package installed"
              
              # Step 2: Verify Python import works
              echo "Step 2: Verifying Python import..."
              python -c "from rebrowser_playwright.async_api import async_playwright; print('‚úÖ Import successful')" || {
                echo "‚ùå FAILED: Cannot import rebrowser_playwright"
                exit 1
              }
              
              # Step 3: Install Chromium browser using MULTIPLE methods
              echo "Step 3: Installing Chromium browser..."
              
              # Method A: Try standard playwright install (uses standard cache)
              echo "Method A: Using standard playwright install..."
              playwright install chromium && {
                echo "‚úÖ Method A succeeded: Standard playwright install worked"
              } || {
                echo "‚ö†Ô∏è Method A failed, trying Method B..."
                
                # Method B: Try rebrowser-specific install
                echo "Method B: Using rebrowser-playwright install..."
                python -m rebrowser_playwright install chromium && {
                  echo "‚úÖ Method B succeeded: rebrowser-playwright install worked"
                } || {
                  echo "‚ö†Ô∏è Method B failed, trying Method C..."
                  
                  # Method C: Try npx installation
                  echo "Method C: Using npx rebrowser-playwright..."
                  npx --yes rebrowser-playwright@latest install chromium && {
                    echo "‚úÖ Method C succeeded: npx install worked"
                  } || {
                    echo "‚ö†Ô∏è Method C failed, trying Method D..."
                    
                    # Method D: Manual installation via Python API
                    echo "Method D: Manual installation via Python API..."
                    python << 'PYTHON_SCRIPT'
from rebrowser_playwright.sync_api import sync_playwright
try:
    p = sync_playwright().start()
    browser_type = p.chromium
    print('Installing browser via Python API...')
    # Try to trigger browser download
    try:
        browser_type.launch(timeout=5000)
    except:
        pass
    p.stop()
    print('‚úÖ Method D succeeded: Manual Python API install worked')
except Exception as e:
    print(f'‚ö†Ô∏è Method D failed: {e}')
    print('Browser will attempt to download on first run')
PYTHON_SCRIPT
                  }
                }
              }
              
              # Step 4: Verify installation (don't fail if browser not found)
              echo "Step 4: Final verification..."
              python << 'VERIFY_SCRIPT'
from rebrowser_playwright.sync_api import sync_playwright
import os
try:
    p = sync_playwright().start()
    print('‚úÖ rebrowser-playwright API verified')
    cache_path = os.environ.get('PLAYWRIGHT_BROWSERS_PATH', 'default')
    print(f'Browser cache: {cache_path}')
    p.stop()
except Exception as e:
    print(f'‚ö†Ô∏è Verification warning: {e}')
    print('This is OK - browser may download on first launch')
VERIFY_SCRIPT
              
              echo "=========================================="
              echo "‚úÖ rebrowser-playwright setup complete"
              echo "=========================================="
              ;;
          
            *)
              echo "‚ùå Unknown library: ${{ inputs.library }}"
              exit 1
              ;;
          esac
      
      - name: ‚úÖ Verify Library Installation
        run: |
          echo "=========================================="
          echo "Verifying ${{ inputs.library }} is ready..."
          echo "=========================================="
          
          case "${{ inputs.library }}" in
            "playwright")
              python -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); print('‚úÖ Playwright ready'); p.stop()"
              ;;
            "patchright")
              python -c "from patchright.sync_api import sync_playwright; p = sync_playwright().start(); print('‚úÖ Patchright ready'); p.stop()"
              ;;
            "camoufox")
              python -c "import camoufox; print('‚úÖ Camoufox ready')"
              ;;
            "rebrowser_playwright")
              python -c "from rebrowser_playwright.async_api import async_playwright; print('‚úÖ rebrowser_playwright ready')"
              ;;
          esac
          
          echo "‚úÖ Verification complete"
      
      - name: üéØ Run Single Library Test
        env:
          DISPLAY: ':99'
          PROXY_HOST: ${{ secrets.PROXY_HOST }}
          PROXY_PORT: ${{ secrets.PROXY_PORT }}
          PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
        run: |
          # Start virtual display
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          # Build command
          CMD="python main.py --proxy env: --library ${{ inputs.library }}"
          
          if [ "${{ inputs.verbose }}" = "true" ]; then
            CMD="$CMD --verbose"
          fi
          
          echo "Running: $CMD"
          echo "=========================================="
          
          # Run the test with extended timeout for rebrowser
          if [ "${{ inputs.library }}" = "rebrowser_playwright" ]; then
            echo "‚ö†Ô∏è First run may take 1-2 minutes to download browser..."
            timeout 600 $CMD || {
              echo "‚ùå Test timed out or failed"
              exit 1
            }
          else
            $CMD
          fi
      
      - name: üìä Display Results Summary
        if: always()
        run: |
          if [ -d "test_results/reports" ]; then
            echo "=========================================="
            echo "Test Results Summary"
            echo "=========================================="
            
            LATEST_REPORT=$(ls -t test_results/reports/*_summary.md 2>/dev/null | head -1)
            
            if [ -n "$LATEST_REPORT" ]; then
              cat "$LATEST_REPORT"
            else
              echo "No summary report found"
            fi
          fi
      
      - name: üì§ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.library }}-${{ github.run_number }}
          path: |
            test_results/
          retention-days: 30
      
      - name: üì§ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.library }}-${{ github.run_number }}
          path: |
            test_results/screenshots/
          retention-days: 30
      
      - name: ‚úÖ Test Status Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Test Execution Complete"
          echo "=========================================="
          echo "Library: ${{ inputs.library }}"
          echo "Status: Check results above"
          echo "Artifacts uploaded for 30 days"
          echo "=========================================="
