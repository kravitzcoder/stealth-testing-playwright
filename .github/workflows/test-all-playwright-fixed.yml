name: ðŸŽ­ Test All Playwright Libraries (Fixed)

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Mobile device to emulate'
        required: false
        default: 'iphone_x'
        type: choice
        options:
          - iphone_x
          - iphone_12
          - samsung_galaxy
      mode:
        description: 'Test execution mode'
        required: false
        default: 'sequential'
        type: choice
        options:
          - sequential
          - parallel

env:
  PROXY_HOST: ${{ secrets.PROXY_HOST }}
  PROXY_PORT: ${{ secrets.PROXY_PORT }}
  PROXY_USERNAME: ${{ secrets.PROXY_USERNAME }}
  PROXY_PASSWORD: ${{ secrets.PROXY_PASSWORD }}
  CAMOUFOX_SKIP_AUTO_UPDATE: true
  NO_GITHUB_API: true

jobs:
  test-all-playwright:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ðŸ“„ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ”§ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          libgtk-3-0 \
          libnotify-dev \
          libnss3 \
          libxss1 \
          libasound2t64 \
          libxtst6 \
          xauth \
          libgbm1 \
          libxkbcommon0 \
          libxrandr2 \
          libxcomposite1 \
          libxdamage1 \
          libatk-bridge2.0-0 \
          libpango-1.0-0 \
          libcairo2 \
          libatspi2.0-0 \
          chromium-browser \
          firefox \
          wget
        
    - name: ðŸ“¦ Install All Dependencies & Browsers
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
        # Install Playwright browsers
        echo "=== Installing Standard Browsers ==="
        playwright install chromium firefox
        playwright install-deps chromium firefox
        
        # Install Patchright browser
        echo "=== Installing Patchright Browser ==="
        patchright install chromium || echo "âš ï¸ Patchright install warning (continuing)"
        
        # Install Rebrowser Playwright browser - FIXED APPROACH
        echo "=== Installing Rebrowser Playwright Browser ==="
        
        # The key insight: rebrowser-playwright shares the same browser cache as playwright
        # So if playwright browsers are installed, rebrowser should work
        echo "âœ… Rebrowser will use shared playwright browser cache"
        
        # Verify rebrowser can import
        python -c "import rebrowser_playwright; print('âœ… Rebrowser package imported')"
        
        # Test rebrowser browser availability (may auto-download on first use)
        python -c "from rebrowser_playwright.sync_api import sync_playwright; print('âœ… Rebrowser API available')" || echo "âš ï¸ Import warning"
    
    - name: âœ… Verify Browser Installations
      run: |
        echo "=== Browser Verification ==="
        
        # Test standard playwright
        python -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(); print('âœ… Chromium functional'); browser.close(); p.stop()" || {
          echo "âŒ Chromium verification failed!"
          exit 1
        }
        
        # Test patchright
        python -c "from patchright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(); print('âœ… Patchright functional'); browser.close(); p.stop()" || {
          echo "âš ï¸ Patchright verification failed (continuing)"
        }
        
        # Test rebrowser (may trigger auto-download)
        python -c "from rebrowser_playwright.sync_api import sync_playwright; p = sync_playwright().start(); browser = p.chromium.launch(headless=True); print('âœ… Rebrowser functional'); browser.close(); p.stop()" || {
          echo "âš ï¸ Rebrowser verification failed - will try auto-download during tests"
        }
        
    - name: âœ… Validate Installation Versions
      run: |
        echo "=== Installation Verification ==="
        echo "Python packages:"
        pip list | grep -E "playwright|patchright|camoufox|pygeoip|rebrowser"
        echo ""
        echo "Playwright browsers:"
        playwright install --list || true
        
    - name: âœ… Validate Proxy Configuration
      run: |
        if [ -z "$PROXY_HOST" ] || [ -z "$PROXY_PORT" ]; then
          echo "âŒ Proxy configuration missing!"
          echo "Please set PROXY_HOST and PROXY_PORT secrets"
          exit 1
        fi
        echo "âœ… Proxy configured: $PROXY_HOST:$PROXY_PORT"
        
    - name: ðŸ“‚ Create Required Directories
      run: |
        mkdir -p test_results/screenshots
        mkdir -p test_results/reports
        chmod -R 755 test_results
        
    - name: ðŸŽ­ Run All Playwright Tests
      run: |
        export DISPLAY=:99
        
        python main.py \
          --proxy env: \
          --all \
          --device "${{ inputs.device }}" \
          --mode "${{ inputs.mode }}" \
          --output-prefix "all_playwright" \
          --verbose
          
    - name: ðŸ“¸ Verify Results
      if: always()
      run: |
        echo "=== Test Results ==="
        echo "Screenshots:"
        ls -lh test_results/screenshots/ 2>/dev/null | tail -n 30 || echo "No screenshots"
        echo ""
        echo "Screenshot count by library:"
        for lib in playwright patchright camoufox rebrowser_playwright; do
          COUNT=$(ls test_results/screenshots/${lib}* 2>/dev/null | wc -l)
          echo "  $lib: $COUNT screenshots"
        done
        echo ""
        echo "Reports:"
        ls -lh test_results/reports/ 2>/dev/null | tail -n 10 || echo "No reports"
        
    - name: ðŸ“¸ Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-all-playwright-${{ github.run_number }}
        path: test_results/screenshots/
        retention-days: 7
        if-no-files-found: warn
        
    - name: ðŸ“Š Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: reports-all-playwright-${{ github.run_number }}
        path: test_results/reports/
        retention-days: 30
        if-no-files-found: warn
        
    - name: ðŸ“‹ Test Results Summary
      if: always()
      run: |
        echo "## ðŸŽ­ All Playwright Libraries Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Device:** ${{ inputs.device }}" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ inputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f test_results/reports/*_summary.md ]; then
          echo "### Detailed Results" >> $GITHUB_STEP_SUMMARY
          cat test_results/reports/*_summary.md >> $GITHUB_STEP_SUMMARY
        fi